---
title: è¯‘|é€šè¿‡Nodeå’ŒRedisè¿›è¡ŒAPIé€Ÿç‡é™åˆ¶
date: 2020-09-16 11:04:22
categories:
  - æŠ€æœ¯
tags:
  - å…¨æ ˆå¼€å‘
  - ç¿»è¯‘
---

![](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/banner.jpeg)

é€Ÿç‡é™åˆ¶å¯ä»¥ä¿æŠ¤å’Œæé«˜åŸºäº API çš„æœåŠ¡çš„å¯ç”¨æ€§ã€‚å¦‚æœä½ æ­£åœ¨ä¸ä¸€ä¸ª API å¯¹è¯ï¼Œå¹¶æ”¶åˆ° HTTP 429 Too Many Requests çš„å“åº”çŠ¶æ€ç ï¼Œè¯´æ˜ä½ å·²ç»è¢«é€Ÿç‡é™åˆ¶äº†ã€‚è¿™æ„å‘³ç€ä½ è¶…å‡ºäº†ç»™å®šæ—¶é—´å†…å…è®¸çš„è¯·æ±‚æ•°é‡ã€‚ä½ éœ€è¦åšçš„å°±æ˜¯æ”¾æ…¢è„šæ­¥ï¼Œç¨ç­‰ç‰‡åˆ»ï¼Œç„¶åå†è¯•ä¸€æ¬¡ã€‚

<!-- more -->

## ä¸ºä»€ä¹ˆè¦é€Ÿç‡é™åˆ¶ï¼Ÿ

å½“ä½ è€ƒè™‘é™åˆ¶ä½ è‡ªå·±çš„åŸºäº API çš„æœåŠ¡æ—¶ï¼Œä½ éœ€è¦åœ¨ç”¨æˆ·ä½“éªŒã€å®‰å…¨æ€§å’Œæ€§èƒ½ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚

![](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/1.png)

æ§åˆ¶æ•°æ®æµçš„æœ€å¸¸è§åŸå› æ˜¯ä¿æŒåŸºäº API çš„æœåŠ¡çš„å¯ç”¨æ€§ã€‚ä½†ä¹Ÿæœ‰å®‰å…¨æ–¹é¢çš„å¥½å¤„ï¼Œä¸€æ¬¡æ— æ„æˆ–æœ‰æ„çš„å…¥ç«™æµé‡æ¿€å¢ï¼Œå°±ä¼šå ç”¨å®è´µçš„èµ„æºï¼Œå½±å“å…¶ä»–ç”¨æˆ·çš„å¯ç”¨æ€§ã€‚

é€šè¿‡æ§åˆ¶ä¼ å…¥è¯·æ±‚çš„é€Ÿç‡ï¼Œä½ å¯ä»¥ï¼š

- ä¿éšœæœåŠ¡å’Œèµ„æºä¸è¢«â€œæ·¹æ²¡â€ã€‚
- ç¼“å’Œæš´åŠ›æ”»å‡»
- é˜²æ­¢åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡ï¼ˆDDOSï¼‰æ”»å‡»

## å¦‚ä½•å®æ–½é™é€Ÿï¼Ÿ

é€Ÿç‡é™åˆ¶å¯ä»¥åœ¨å®¢æˆ·ç«¯çº§åˆ«ï¼Œåº”ç”¨ç¨‹åºçº§åˆ«ï¼ŒåŸºç¡€æ¶æ„çº§åˆ«æˆ–ä»‹äºä¸¤è€…ä¹‹é—´çš„ä»»ä½•ä½ç½®å®ç°ã€‚æœ‰å‡ ç§æ–¹æ³•å¯ä»¥æ§åˆ¶ API æœåŠ¡çš„å…¥ç«™æµé‡ï¼š

- **æŒ‰ç”¨æˆ·**ï¼šè·Ÿè¸ªç”¨æˆ·ä½¿ç”¨ API å¯†é’¥ã€è®¿é—®ä»¤ç‰Œæˆ– IP åœ°å€è¿›è¡Œçš„è°ƒç”¨
- **æŒ‰åœ°ç†åŒºåŸŸåˆ’åˆ†**ï¼šä¾‹å¦‚é™ä½æ¯ä¸ªåœ°ç†åŒºåŸŸåœ¨ä¸€å¤©çš„é«˜å³°æ—¶æ®µçš„é€Ÿç‡é™åˆ¶
- **æŒ‰æœåŠ¡å™¨**ï¼šå¦‚æœä½ æœ‰å¤šä¸ªæœåŠ¡å™¨å¤„ç†å¯¹ API çš„ä¸åŒè°ƒç”¨ï¼Œä½ å¯èƒ½ä¼šå¯¹è®¿é—®æ›´æ˜‚è´µçš„èµ„æºå®æ–½æ›´ä¸¥æ ¼çš„é€Ÿç‡é™åˆ¶ã€‚

ä½ å¯ä»¥ä½¿ç”¨è¿™äº›é€Ÿç‡é™åˆ¶ä¸­çš„ä»»ä½•ä¸€ç§ï¼ˆç”šè‡³ç»„åˆä½¿ç”¨ï¼‰ã€‚

![](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/2.png)

æ— è®ºä½ é€‰æ‹©å¦‚ä½•å®ç°ï¼Œé€Ÿç‡é™åˆ¶çš„ç›®æ ‡éƒ½æ˜¯å»ºç«‹ä¸€ä¸ªæ£€æŸ¥ç‚¹ï¼Œè¯¥æ£€æŸ¥ç‚¹æ‹’ç»æˆ–é€šè¿‡è®¿é—®ä½ çš„èµ„æºçš„è¯·æ±‚ã€‚è®¸å¤šç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶éƒ½æœ‰å®ç°è¿™ä¸€ç‚¹çš„å†…ç½®åŠŸèƒ½æˆ–ä¸­é—´ä»¶ï¼Œè¿˜æœ‰å„ç§é€Ÿç‡é™åˆ¶ç®—æ³•çš„é€‰é¡¹ã€‚

è¿™æ˜¯ä½¿ç”¨ Node å’Œ Redis åˆ¶ä½œè‡ªå·±çš„é€Ÿç‡é™åˆ¶å™¨çš„ä¸€ç§æ–¹æ³•ï¼š

1. åˆ›å»ºä¸€ä¸ª Node åº”ç”¨
2. ä½¿ç”¨ Redis æ·»åŠ é€Ÿç‡é™åˆ¶å™¨
3. åœ¨ Postman ä¸­æµ‹è¯•

> ğŸ’» åœ¨[GitHub](https://github.com/loopDelicious/rate-limiter)ä¸ŠæŸ¥çœ‹ä»£ç ç¤ºä¾‹ã€‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²åœ¨è®¡ç®—æœºä¸Šå®‰è£…äº† Node å’Œ Redisã€‚

## æ­¥éª¤ 1ï¼šå»ºç«‹ Node åº”ç”¨ç¨‹åº

ä»å‘½ä»¤è¡Œè®¾ç½®ä¸€ä¸ªæ–°çš„ Node åº”ç”¨ã€‚é€šè¿‡ CLI æç¤ºï¼Œæˆ–æ·»åŠ  `â€”yes` æ ‡å¿—æ¥æ¥å—é»˜è®¤é€‰é¡¹ã€‚

```shell
$ npm init --yes
```

å¦‚æœåœ¨é¡¹ç›®è®¾ç½®è¿‡ç¨‹ä¸­æ¥å—äº†é»˜è®¤é€‰é¡¹ï¼Œåˆ™ä¸ºå…¥å£ç‚¹åˆ›å»ºä¸€ä¸ªåä¸º `index.js` çš„æ–‡ä»¶ã€‚

```shell
$ touch index.js
```

å®‰è£… Express Web æ¡†æ¶ï¼Œç„¶ååœ¨ `index.js` ä¸­åˆå§‹åŒ–æœåŠ¡å™¨ã€‚

```javascript
const express = require("express");
const app = express();
const port = process.env.PORT || 3000;

app.get("/", (req, res) => res.send("Hello World!"));
app.listen(port, () =>
  console.log(`Example app listening at http://localhost:${port}`)
);
```

ä»å‘½ä»¤è¡Œå¯åŠ¨æœåŠ¡å™¨ã€‚

```shell
$ node index.js
```

å›åˆ° `index.js` ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªè·¯ç”±ï¼Œå…ˆæ£€æŸ¥é€Ÿç‡é™åˆ¶ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰è¶…è¿‡é™åˆ¶å†å…è®¸è®¿é—®èµ„æºã€‚

```javascript
app.post("/", async (req, res) => {
  async function isOverLimit(ip) {
    // to define
  }
  // æ£€æŸ¥ç‡é™åˆ¶
  let overLimit = await isOverLimit(req.ip);
  if (overLimit) {
    res.status(429).send("Too many requests - try again later");
    return;
  }
  // å…è®¸è®¿é—®èµ„æº
  res.send("Accessed the precious resources!");
});
```

![åº”ç”¨çº§é€Ÿç‡é™åˆ¶](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/3.png)

åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†å®šä¹‰é€Ÿç‡é™åˆ¶å™¨å‡½æ•° `isOverLimit`ã€‚

## æ­¥éª¤ 2ï¼šä½¿ç”¨ Redis æ·»åŠ é€Ÿç‡é™åˆ¶å™¨

Redis æ˜¯ä¸€ä¸ªå†…å­˜ä¸­é”®å€¼æ•°æ®åº“ï¼Œå› æ­¤å®ƒå¯ä»¥éå¸¸å¿«é€Ÿåœ°æ£€ç´¢æ•°æ®ã€‚ä½¿ç”¨ Redis å®æ–½é€Ÿç‡é™åˆ¶ä¹Ÿéå¸¸ç®€å•ã€‚

- å­˜å‚¨ä¸€ä¸ªåƒç”¨æˆ· IP åœ°å€ä¸€æ ·çš„ keyã€‚
- å¢åŠ ä»è¯¥ IP å‘å‡ºçš„è°ƒç”¨æ•°é‡
- åœ¨æŒ‡å®šæ—¶é—´æ®µåä½¿è®°å½•è¿‡æœŸ

ä¸‹å›¾æ‰€ç¤ºçš„é™é€Ÿç®—æ³•æ˜¯ä¸€ä¸ª**æ»‘åŠ¨çª—å£è®¡æ•°å™¨**çš„ä¾‹å­ã€‚ä¸€ä¸ªç”¨æˆ·å¦‚æœæäº¤çš„è°ƒç”¨æ•°é‡é€‚ä¸­ï¼Œæˆ–è€…éšç€æ—¶é—´çš„æ¨ç§»å°†å®ƒä»¬åˆ†éš”å¼€ï¼Œå°±æ°¸è¿œä¸ä¼šè¾¾åˆ°é€Ÿç‡é™åˆ¶ã€‚è¶…è¿‡ 10 ç§’çª—å£å†…æœ€å¤§è¯·æ±‚çš„ç”¨æˆ·å¿…é¡»ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´æ¥æ¢å¤å…¶è¯·æ±‚ã€‚

![é™é€Ÿç®—æ³•ï¼šæ»‘åŠ¨çª—å£è®¡æ•°å™¨](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/4.png)

ä»å‘½ä»¤è¡Œä¸º Node å®‰è£…ä¸€ä¸ªåä¸º ioredis çš„ Redis å®¢æˆ·ç«¯ã€‚

```shell
$ npm install ioredis
```

åœ¨æœ¬åœ°å¯åŠ¨ Redis æœåŠ¡å™¨ã€‚

```shell
$ redis-server
```

ç„¶ååœ¨ `index.js` ä¸­è¦æ±‚å¹¶åˆå§‹åŒ– Redis å®¢æˆ·ç«¯ã€‚

```javascript
const redis = require("ioredis");
const client = redis.createClient({
  port: process.env.REDIS_PORT || 6379,
  host: process.env.REDIS_HOST || "localhost",
});
client.on("connect", function() {
  console.log("connected");
});
```

å®šä¹‰æˆ‘ä»¬ä¸Šä¸€æ­¥å¼€å§‹å†™çš„ isOverLimit å‡½æ•°ï¼ŒæŒ‰ç…§ Redis çš„è¿™ä¸ªæ¨¡å¼ï¼ŒæŒ‰ç…§ IP æ¥ä¿å­˜ä¸€ä¸ªè®¡æ•°å™¨ã€‚

```javascript
async function isOverLimit(ip) {
  let res;
  try {
    res = await client.incr(ip);
  } catch (err) {
    console.error("isOverLimit: could not increment key");
    throw err;
  }
  console.log(`${ip} has value: ${res}`);
  if (res > 10) {
    return true;
  }
  client.expire(ip, 10);
}
```

è¿™å°±æ˜¯é€Ÿç‡é™åˆ¶å™¨ã€‚

å½“ç”¨æˆ·è°ƒç”¨ API æ—¶ï¼Œæˆ‘ä»¬ä¼šæ£€æŸ¥ Redis ä»¥æŸ¥çœ‹è¯¥ç”¨æˆ·æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼ŒAPI å°†ç«‹å³è¿”å› HTTP 429 çŠ¶æ€ä»£ç ï¼Œå¹¶æ˜¾ç¤ºæ¶ˆæ¯ `Too many requests â€” try again later` ã€‚å¦‚æœç”¨æˆ·åœ¨é™åˆ¶ä¹‹å†…ï¼Œæˆ‘ä»¬å°†ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªä»£ç å—ï¼Œåœ¨è¯¥ä»£ç å—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å…è®¸è®¿é—®å—ä¿æŠ¤çš„èµ„æºï¼ˆä¾‹å¦‚æ•°æ®åº“ï¼‰ã€‚

åœ¨è¿›è¡Œé€Ÿç‡é™åˆ¶æ£€æŸ¥æœŸé—´ï¼Œæˆ‘ä»¬åœ¨ Redis ä¸­æ‰¾åˆ°ç”¨æˆ·çš„è®°å½•ï¼Œå¹¶å¢åŠ å…¶è¯·æ±‚è®¡æ•°ï¼Œå¦‚æœ Redis ä¸­æ²¡æœ‰è¯¥ç”¨æˆ·çš„è®°å½•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°è®°å½•ã€‚æœ€åï¼Œæ¯æ¡è®°å½•å°†åœ¨æœ€è¿‘ä¸€æ¬¡æ´»åŠ¨çš„ 10 ç§’å†…è¿‡æœŸã€‚

åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œè¯·ç¡®ä¿æˆ‘ä»¬çš„é™é€Ÿå™¨æ­£å¸¸è¿è¡Œã€‚

## æ­¥éª¤ 3ï¼šåœ¨ Postman ä¸­è¿›è¡Œæµ‹è¯•

ä¿å­˜æ›´æ”¹ï¼Œç„¶åé‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Postman å°† `POST` è¯·æ±‚å‘é€åˆ°æˆ‘ä»¬çš„ API æœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨åœ¨æœ¬åœ°è¿è¡Œï¼Œç½‘å€ä¸º `http:// localhost:3000`ã€‚

![åœ¨é€Ÿç‡é™åˆ¶å†…](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/5.png)

ç»§ç»­å¿«é€Ÿè¿ç»­å‘é€è¯·æ±‚ä»¥è¾¾åˆ°ä½ çš„é€Ÿç‡é™åˆ¶ã€‚

![è¶…è¿‡é€Ÿç‡é™åˆ¶-HTTP 429è¯·æ±‚è¿‡å¤š](http://myimgcloud.oss-cn-hangzhou.aliyuncs.com/202009/api-rate-limiting-with-node-and-redis/6.gif)

## å…³äºé™é€Ÿçš„æœ€ç»ˆæƒ³æ³•

è¿™æ˜¯ Node å’Œ Redis çš„é€Ÿç‡é™åˆ¶å™¨çš„ç®€å•ç¤ºä¾‹ï¼Œè¿™åªæ˜¯å¼€å§‹ã€‚æœ‰ä¸€å †ç­–ç•¥å’Œå·¥å…·å¯ä»¥ç”¨æ¥æ¶æ„å’Œå®ç°ä½ çš„é€Ÿç‡é™åˆ¶ã€‚è€Œä¸”è¿˜æœ‰å…¶ä»–çš„å¢å¼ºåŠŸèƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªä¾‹å­æ¥æ¢ç´¢ï¼Œæ¯”å¦‚ï¼š

- åœ¨å“åº”æ­£æ–‡æˆ–ä½œä¸º `Retry-after` æ ‡å¤´ä¸­ï¼Œè®©ç”¨æˆ·çŸ¥é“åœ¨é‡è¯•ä¹‹å‰åº”è¯¥ç­‰å¾…å¤šå°‘æ—¶é—´
- è®°å½•è¾¾åˆ°é€Ÿç‡é™åˆ¶çš„è¯·æ±‚ï¼Œä»¥äº†è§£ç”¨æˆ·è¡Œä¸ºå¹¶è­¦å‘Šæ¶æ„æ”»å‡»
- å°è¯•ä½¿ç”¨å…¶ä»–é€Ÿç‡é™åˆ¶ç®—æ³•æˆ–å…¶ä»–ä¸­é—´ä»¶

è¯·è®°ä½ï¼Œå½“ä½ ç ”ç©¶ API é™åˆ¶æ—¶ï¼Œä½ æ˜¯åœ¨æ€§èƒ½ã€å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚ä½ ç†æƒ³çš„é€Ÿç‡é™åˆ¶è§£å†³æ–¹æ¡ˆå°†éšç€æ—¶é—´çš„æ¨ç§»è€Œæ”¹å˜ï¼ŒåŒæ—¶ä¹Ÿä¼šè€ƒè™‘åˆ°è¿™äº›å› ç´ ã€‚

> åŸæ–‡ï¼š[https://codeburst.io](https://codeburst.io/api-rate-limiting-with-node-and-redis-95354259c768)ï¼Œä½œè€…ï¼šJoyce Lin
